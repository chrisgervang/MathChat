keycodes = [
  [192, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 189, 187, 8],
  [9, 81, 87, 69, 82, 84, 89, 85, 73, 79, 80, 219, 221, 220],
  [20, 65, 83, 68, 70, 71, 72, 74, 75, 76, 186, 222, 13],
  [16, 90, 88, 67, 86, 66, 78, 77, 188, 190, 191, 16],
  [999, 17, 18, 91, 32, 93, 18, 37, 38, 40, 39]
]

optable =
  Integral:
    MathML:"""
          <msubsup>
            <mo>&Integral;</mo>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
          </msubsup>
          """
  Tilde:
    MathML:"<mo>~</mo>"
  NotEqual:
    MathML:"<mo>&NotEqual;</mo>"
  parallel:
    MathML:"<mo>&parallel;</mo>"
  Percent:
    MathML:"<mo>%</mo>"
  SquareRoot:
    MathML:"""
          <msqrt>
            <mrow>
              <mo>&square;</mo>
            </mrow>
          </msqrt>
          """
  PlusMinus:
    MathML:"<mo>&PlusMinus;</mo>"
  times:
    MathML:"<mo>&times;</mo>"
  minus:
    MathML:"<mo>-</mo>"
  equals:
    MathML:"<mo>=</mo>"
  log:
    MathML:"<mo>log</mo>"
  epsilon:
    MathML:"<mo>&epsilon;</mo>"
  Union:
    MathML:"""
            <munderover>
              <mo>&Union;</mo>
              <mrow>
                <mo>&EmptyVerySmallSquare;</mo>
              </mrow>
              <mrow>
                <mo>&EmptyVerySmallSquare;</mo>
              </mrow>
            </munderover>
          """
  dx:
    MathML:"<mo>d<mi>x</mi></mo>"
  Product:
    MathML:"""
          <munderover>
            <mo>&Product;</mo>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
          </munderover>
          """
  leftBracket:
    MathML:"<mo>[</mo>"
  rightBracket:
    MathML:"<mo>]</mo>"
  logicalAnd:
    MathML:"<mo>&and;</mo>"
  toggleKeyboard:
    MathML:"<mo>&#9000;</mo>"
  Sum:
    MathML:"""
          <munderover>
            <mo>&Sum;</mo>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
          </munderover>
          """
  Delta:
    MathML:"<mo>&Delta;</mo>"
  MathFunction:
    MathML:"<mo>&#x192;</mo>"
  sin:
    MathML:"<mo>sin</mo>"
  cos:
    MathML:"<mo>cos</mo>"
  tan:
    MathML:"<mo>tan</mo>"
  lambda:
    MathML:"<mo>&lambda;</mo>"
  pi:
    MathML:"<mo>&pi;</mo>"
  langle:
    MathML:"<mo>&langle;</mo>"
  superScript:
    MathML:"""
            <msup>
              <mo>sup</mo>
              <mrow>
                <mo>x</mo>
              </mrow>
            </msup>
          """
  ForAll:
    MathML:"<mo>&ForAll;</mo>"
  Exists:
    MathML:"<mo>&Exists;</mo>"
  in:
    MathML:"<mo>&in;</mo>"
  lessThan:
    MathML:"<mo><</mo>"
  greaterThan:
    MathML:"<mo>></mo>"
  divide:
    MathML:"<mo>&divide;</mo>"
  backspace:
    MathML:"<mo>&#9003;</mo>"
  rarr:
    MathML:"<mo>&rarr;</mo>"
  larr:
    MathML:"<mo>&larr;</mo>"
  uarr:
    MathML:"<mo>&uarr;</mo>"
  darr:
    MathML:"<mo>&darr;</mo>"
  Not:
    MathML:"<mo>!</mo>"
  approx:
    MathML:"<mo>&approx;</mo>"
  TildeFullEqual:
    MathML:"<mo>&TildeFullEqual;</mo>"
  nparallel:
    MathML:"<mo>&nparallel;</mo>"
  AnyRoot:
    MathML:"""
          <mroot>
            <mrow>
              <mo>&square;</mo>
            </mrow>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
          </mroot>
          """
  openParen:
    MathML:"<mo>(</mo>"
  closeParen:
    MathML:"<mo>)</mo>"
  plus:
    MathML:"<mo>+</mo>"
  ln:
    MathML:"<mo>ln</mo>"
  emptyset:
    MathML:"<mo>&emptyset;</mo>"
  eulersConst:
    MathML:"<mo><mi>e</mi></mo>"
  Intersection:
    MathML:"""
          <munderover>
            <mo>&Intersection;</mo>
              <mrow>
                <mo>&EmptyVerySmallSquare;</mo>
              </mrow>
              <mrow>
                <mo>&EmptyVerySmallSquare;</mo>
              </mrow>
          </munderover>
          """
  DoubleIntegral:
    MathML:"""
          <msubsup>
            <mo>&Integral;&Integral;</mo>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
            <mrow>
              <mo>&EmptyVerySmallSquare;</mo>
            </mrow>
          </msubsup>
          """
  dtheta:
    MathML:"<mo>d<mi>&theta;</mi></mo>"
  CircleTimes:
    MathML:"<mo>&CircleTimes;</mo>"
  CirclePlus:
    MathML:"<mo>&CirclePlus;</mo>"
  leftCurly:
    MathML:"<mo>{</mo>"
  rightCurly:
    MathML:"<mo>}</mo>"
  logicalOr:
    MathML:"<mo>&or;</mo>"
  PartialD:
    MathML:"<mo>&PartialD;</mo>"
  Infinity:
    MathML:"<mo>&#x221E;</mo>"
  csc:
    MathML:"<mo>csc</mo>"
  sec:
    MathML:"<mo>sec</mo>"
  cot:
    MathML:"<mo>cot</mo>"
  range:
    MathML:"""
          <mover>
            <mrow>
              <mo>&Square;</mo>
            </mrow>
            <mo>&#x308;</mo>
          </mover>
          """
  lessThanOrEqual:
    MathML:"<mo>&leq;</mo>"
  greaterThanOrEqual:
    MathML:"<mo>&geq;</mo>"
  fraction:
    MathML:"""
          <mfrac>
            <mrow>
              <mo>&Square;</mo>
            </mrow>
            <mrow>
              <mo>&Square;</mo>
            </mrow>
          </mfrac>
          """

combine = (keyboards) ->
  newKeyboard = {}

  for mode, keyboard of keyboards
    newMode = newKeyboard[mode] = []

    for row, i in keyboard
      newMode.push []

      for key, j in row
        newObj = {}
        newObj.code = keycodes[i][j]
        newObj.func = key
        newObj.id = "key-#{keycodes[i][j]}"

        newMode[i].push newObj
  # console.log newKeyboard
  newKeyboard


Ctrl.define
  'keyboard':
    ready: ->

      # @autorun =>
      #   foo = @api.keyboardMode()
      #   $('.key .letter.-symbol').html()


      children = @children

      Util.keyboard.keyDown (e) =>

        if e.which is 20 # caps lock
          @api.keyboardMode('math')

        if e.which is 16 # shft
          @api.keyboardMode('shift')

        # if e.which is 'alt'

        children["key-#{e.which}"]?.isPressed(true)
        console.log @api.keyboardMode()
        if @api.keyboardMode() isnt 'default'
          # console.log children["key-#{e.which}"]

          hackCombinedObject = @helpers.combined()[@api.keyboardMode()]

          for row, i in hackCombinedObject
            # console.log row, i
            for col in row
              if col.id is children["key-#{e.which}"].id
                Session.set("InputMathML", {MathML: optable[col.func]?.MathML, func: col.func})
          # console.log children["key-#{e.which}"]?.context.helpers.symbol()

          e.preventDefault()

      Util.keyboard.keyUp (e) =>

        if e.which is 20
          @api.keyboardMode('default')

        if e.which is 16
          @api.keyboardMode('math')

        children["key-#{e.which}"]?.isPressed(false)

    api:
      keyboardMode: (value) -> @prop 'keyboardState', value, default:'default'

    helpers:
      combined: -> combine(@data.customKeyboard)
      keys: -> @helpers.combined()[@api.keyboardMode()]
